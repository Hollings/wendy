version: '3.8'

services:
  bot:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: wendy-bot
    restart: unless-stopped
    command: ["python", "-m", "bot"]
    network_mode: host
    volumes:
      - wendy_data:/data/wendy
      - claude_config:/root/.claude
      - /srv/secrets/wendy:/secrets:ro
    env_file:
      - /srv/secrets/wendy/bot.env
    environment:
      - WENDY_DB_PATH=/data/wendy/shared/wendy.db
      - SYSTEM_PROMPT_FILE=/app/config/system_prompt.txt
      - CLAUDE_CLI_TIMEOUT=300
      - WENDY_SECRETS_FILE=/data/wendy/secrets/runtime.json
      - MESSAGE_LOGGER_GUILDS=1020445108707000331
    depends_on:
      - proxy

  proxy:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: wendy-proxy
    restart: unless-stopped
    command: ["uvicorn", "proxy.main:app", "--host", "0.0.0.0", "--port", "8945"]
    network_mode: host
    volumes:
      - wendy_data:/data/wendy
      - /srv/secrets/wendy:/secrets:ro
    env_file:
      - /srv/secrets/wendy/bot.env
    environment:
      - WENDY_DB_PATH=/data/wendy/shared/wendy.db
      - WENDY_SITES_URL=http://127.0.0.1:8910
      - WENDY_GAMES_URL=http://127.0.0.1:8920

  orchestrator:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: wendy-orchestrator
    restart: unless-stopped
    command: ["python", "-m", "orchestrator"]
    network_mode: host
    volumes:
      - wendy_data:/data/wendy
      - claude_config:/root/.claude
      - /srv/secrets/wendy:/secrets:ro
    env_file:
      - /srv/secrets/wendy/bot.env
    environment:
      - ORCHESTRATOR_CONCURRENCY=3
      - ORCHESTRATOR_POLL_INTERVAL=30
      - ORCHESTRATOR_WORKING_DIR=/data/wendy
      - ORCHESTRATOR_PROXY_URL=http://127.0.0.1:8945
      - AGENT_SYSTEM_PROMPT_FILE=/app/config/agent_claude_md.txt
      - WENDY_DB_PATH=/data/wendy/shared/wendy.db
      - ORCHESTRATOR_NOTIFY_CHANNEL=1461429474250850365
    depends_on:
      - proxy

volumes:
  wendy_data:
    external: true
    name: wendy_data
  claude_config:
    external: true
    name: claude_config
